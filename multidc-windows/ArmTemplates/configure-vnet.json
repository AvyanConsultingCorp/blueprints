{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vnetName": {
      "type": "string",
      "metadata": {
        "description": "Name of the VNET."
      }
    },
    "vnetAddressPrefixes": {
      "type": "array",
      "metadata": {
        "description": "Address spaces for the VNET"
      }
    },
    "vnetFrontendSubnet": {
      "type": "object",
      "metadata": {
        "description": "Name and prefix of the frontend subnet in the VNET. Please note, an additional subnet called GatewaySubnet will be created where the VirtualNetworkGateway will be deployed. The name of that subnet must not be changed from GatewaySubnet."
      }
    },
    "vnetBackendSubnetDc": {
      "type": "object",
      "metadata": {
        "description": "Name and prefix of the domain controller backend subnet in the VNET. Please note, an additional subnet called GatewaySubnet will be created where the VirtualNetworkGateway will be deployed. The name of that subnet must not be changed from GatewaySubnet."
      }
    },
    "vnetBackendSubnetSql": {
      "type": "object",
      "metadata": {
        "description": "Name and prefix of the SQL backend subnet in the VNET. Please note, an additional subnet called GatewaySubnet will be created where the VirtualNetworkGateway will be deployed. The name of that subnet must not be changed from GatewaySubnet."
      }
    },
    "vnetGatewaySubnet": {
      "type": "object",
      "metadata": {
        "description": "Name and prefix for the GatewaySubnet where the VirtualNetworkGateway will be deployed. This must be at least /29."
      }
    },
    "dnsServers": {
      "type": "array",
      "metadata": {
        "description": "DNS address spaces of the VNET to be used for AD domain controller VMs."
      }
    },
    "gatewayName": {
      "type": "string",
      "metadata": {
        "description": "Gateway name of the VNET"
      }
    },
    "vnetGatewayIpName": {
      "type": "string",
      "metadata": {
        "description": "Gateway IP address name of the VNET"
      }
    },
    "vnetDomainLabel": {
      "type": "string",
      "metadata": {
        "description": "Domain label for the public IP address. Required for traffic manager setup."
      }
    },
    "lbFrontendPrivateIp": {
      "type": "string",
      "metadata": {
        "description": "Private IP address of the load balancer frontend for VMs in the subnet."
      }
    },
    "networkInterfacePrefix": {
      "type": "string",
      "metadata": {
        "description": "Prefix for the NIC created for each VM in the subnet."
      }
    },
    "loadBalancerName": {
      "type": "string",
      "metadata": {
        "description": "Name of the loadbalancer in the subnet."
      }
    },
    "vmNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "Prefix for the VM created in the subnet."
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Prefix for the storage account created for the VMs in the subnet."
      }
    },
    "appName": {
      "type": "string",
      "metadata": {
        "description": "App name to be used for SQL configuration."
      }
    },
    "sqlStaticIp": {
      "type": "string",
      "metadata": {
        "description": "Static IP address of the SQL server."
      }
    }
  },
  "variables": {
    "apiVersion": "2016-03-30",
    "gatewayPublicIPName": "[parameters('vnetGatewayIpName')]",
    "region": "[resourceGroup().location]",
    "vnetId": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]",
    "gatewaySubnetRef": "[concat(variables('vnetId'),'/subnets/','GatewaySubnet')]",
    "backendSubnetDcRef": "[concat(variables('vnetId'),'/subnets/',parameters('vnetBackendSubnetDc').name)]",
    "backendSubnetSqlRef": "[concat(variables('vnetId'),'/subnets/',parameters('vnetBackendSubnetSql').name)]",
    "createVMsTemplateUri": "[uri(deployment().properties.templateLink.uri, 'configure-vms.json')]"
  },
  "resources": [
    {
      "apiVersion": "[variables('apiVersion')]",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[parameters('vnetName')]",
      "location": "[variables('region')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes":"[parameters('vnetAddressPrefixes')]"
        },
        "subnets": [
          {
            "name": "[parameters('vnetFrontendSubnet').name]",
            "properties": {
              "addressPrefix": "[parameters('vnetFrontendSubnet').prefix]"
            }
          },
          {
            "name": "[parameters('vnetBackendSubnetDc').name]",
            "properties": {
              "addressPrefix": "[parameters('vnetBackendSubnetDc').prefix]"
            }
          },
          {
            "name": "[parameters('vnetBackendSubnetSql').name]",
            "properties": {
              "addressPrefix": "[parameters('vnetBackendSubnetSql').prefix]"
            }
          },
          {
            "name": "[parameters('vnetGatewaySubnet').name]",
            "properties": {
              "addressPrefix": "[parameters('vnetGatewaySubnet').prefix]"
            }
          }
        ]
      },
      "tags": {
        "displayName": "VirtualNetwork"
      }
    },
    {
      "apiVersion": "[variables('apiVersion')]",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('gatewayPublicIPName')]",
      "location": "[variables('region')]",
      "properties": {
        "publicIPAllocationMethod": "Dynamic"
      },
      "tags": {
        "displayName": "PublicIPAddress"
      }
    },
    {
      "apiVersion": "[variables('apiVersion')]",
      "type": "Microsoft.Network/virtualNetworkGateways",
      "name": "[parameters('gatewayName')]",
      "location": "[variables('region')]",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('gatewayPublicIPName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "subnet": {
                "id": "[variables('gatewaySubnetRef')]"
              },
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('gatewayPublicIpName'))]"
              }
            },
            "name": "vnetGatewayConfig1"
          }
        ],
        "gatewayType": "Vpn",
        "vpnType": "RouteBased",
        "enableBgp": "false"
      },
      "tags": {
        "displayName": "VirtualNetworkGateway"
      }
    },
    {
      "name": "DeployVMs",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-02-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[uri(deployment().properties.templateLink.uri, 'configure-vms.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appName": {
            "value": "[parameters('appName')]"
          },
          "numberOfInstances": {
            "value": 5
          },
          "subnetDcRef": {
            "value": "[variables('backendSubnetDcRef')]"
          },
          "subnetSqlRef": {
            "value": "[variables('backendSubnetSqlRef')]"
          },
          "lbFrontendPrivateIp": {
            "value": "[parameters('lbFrontendPrivateIp')]"
          },
          "projectName": {
            "value": "sqlAlwaysOn"
          },
          "networkInterfacePrefix": {
            "value": "[parameters('networkInterfacePrefix')]"
          },
          "loadBalancerName": {
            "value": "[parameters('loadBalancerName')]"
          },
          "adminUsername": {
            "value": "testuser"
          },
          "adminPassword": {
            "value": "AweS0me@PW"
          },
          "vmNamePrefix": {
            "value": "[parameters('vmNamePrefix')]"
          },
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "dnsServers": {
            "value": "[parameters('dnsServers')]"
          },
          "sqlStaticIp": {
            "value": "[parameters('sqlStaticIp')]"
          },
          "vnetName": {
            "value": "[parameters('vnetName')]"
          },
          "vnetAddressPrefixes": {
            "value": "[parameters('vnetAddressPrefixes')]"
          },
          "vnetBackendSubnetDc": {
            "value": "[parameters('vnetBackendSubnetDc')]"
          },
          "vnetBackendSubnetSql": {
            "value": "[parameters('vnetBackendSubnetSql')]"
          },
          "vnetFrontendSubnet": {
            "value": "[parameters('vnetFrontendSubnet')]"
          },
          "vnetGatewaySubnet": {
            "value": "[parameters('vnetGatewaySubnet')]"
          }
        }
      }
    }
  ],
  "outputs": {
    "vnetGatewayName": {
      "type": "string",
      "value": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('gatewayName'))]"
    }
  }
}