{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "loadBalancerSettings": {
      "type": "object",
      "metadata": {
        "description": "Settings for infrastructure"
      }
    },
    "virtualMachinesSettings": {
      "type": "object",
      "metadata": {
        "description": "Settings for virtual machines"
      }
    },
    "virtualNetworkSettings": {
      "type": "object",
      "metadata": {
        "description": "Settings for virtual network"
      }
    },
    "buildingBlockSettings": {
      "type": "object",
      "metadata": {
        "description": "Settings for building block"
      }
    },
    "routeTableSettings": {
      "type": "object",
      "metadata": {
        "description": "Settings for route table."
      }
    }
  },
  "variables": {
    "location": "[resourceGroup().location]",
    "vmPrefix": "[concat(parameters('virtualMachinesSettings').computerNamePrefix, '-vm')]",
    "routeTableTemplate": "[uri(deployment().properties.templateLink.uri, '../../resources/routeTables/routeTable.json')]",
    "loadBalancerTemplate": "[uri(deployment().properties.templateLink.uri, '../loadBalancer-backend-n-vm/azuredeploy.json')]",
    "extIpFwdTemplate": "[uri(deployment().properties.templateLink.uri, '../../resources/virtualMachines/extensions/linux/enable-ip-forwarding/extension-enable-ip-forwarding.json')]",
    "extensionTemplate": "[uri(deployment().properties.templateLink.uri, '../../resources/virtualMachines/extensions/linux/extension-custom-script-for-linux.json')]",
    "scriptPath": "[uri(deployment().properties.templateLink.uri, '../../resources/virtualMachines/extensions/windows/enable-default-gateway-multi-nic/enable-default-gateway.ps1')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "name": "deploy-route-table",
      "dependsOn": [
        "Microsoft.Resources/deployments/deploy-load-balancer-multivm"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": { "uri": "[variables('routeTableTemplate')]" },
        "parameters": {
          "virtualNetworkSettings": { "value": "[parameters('virtualNetworkSettings')]" },
          "routeTableSettings": { "value": "[parameters('routeTableSettings')]" }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "name": "deploy-load-balancer-multivm",
      "properties": {
        "mode": "Incremental",
        "templateLink": { "uri": "[variables('loadBalancerTemplate')]" },
        "parameters": {
          "virtualMachinesSettings": { "value": "[parameters('virtualMachinesSettings')]" },
          "virtualNetworkSettings": { "value": "[parameters('virtualNetworkSettings')]" },
          "buildingBlockSettings": { "value": "[parameters('buildingBlockSettings')]" },
          "loadBalancerSettings": { "value": "[parameters('loadBalancerSettings')]" }
        }
      }
    },
        {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2015-06-15",
      "name": "[concat(variables('vmPrefix'), add(parameters('buildingBlockSettings').vmStartIndex, copyindex()), '/nva-extension')]",
      "copy": {
        "count": "[parameters('buildingBlockSettings').vmCount]",
        "name": "nvaSetupLoop"
      },
      "dependsOn": [
        "Microsoft.Resources/deployments/deploy-load-balancer-multivm",
        "Microsoft.Resources/deployments/deploy-route-table"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "CustomScriptExtension",
        "typeHandlerVersion": "1.8",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "fileUris": "[variables('scriptPath')]",
          "commandToExecute": "powershell -ExecutionPolicy Unrestricted -File enable-default-gateway.ps1')"
        }
      }
    }
  ]
}
